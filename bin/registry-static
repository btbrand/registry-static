#!/usr/bin/env node
/*
Copyright (c) 2014, Yahoo! Inc. All rights reserved.
Code licensed under the BSD License.
See LICENSE file.
*/
var exec = require('child_process').spawn;
var argv = process.argv.slice(2);
var path = require('path');
var args = require('../lib/args');
var options = args();
var fs = require('fs');

if (options.help || options.version) {
    require('../lib/index');
    return;
}

var pidFile = path.join(options.tmp, 'registry-static.pid');

if (options.restart) {
    var pid = fs.readFileSync(pidFile, 'utf8');
    console.log('\n\n--------------------------------');
    console.log('Restarting process %s', pid);
    console.log('--------------------------------\n\n');
    process.kill(pid, 'SIGHUP');
    return;
}


fs.writeFileSync(pidFile, process.pid, 'utf8');

var child;

process.on('exit', function() {
    console.log('Cleaning up pidfile');
    fs.unlinkSync(pidFile);
});

process.on('SIGHUP', function() {
    console.log('\n\n--------------------------------');
    console.log('SIGHUP received, restarting child process (' + child.pid + ')');
    console.log('--------------------------------\n\n');
    process.kill(child.pid, 'SIGKILL');
});

argv.unshift(path.join(__dirname, '../lib/background.js'));
console.log('\n\n--------------------------------');
console.log('starting background task..');
console.log('--------------------------------\n\n');
var proc = 0;
var run = function(c) {
    if (c) {
        //Only count the respawn if there is an exit code
        proc++;
    }
    if (proc >= options.spawn) {
        console.log('\n\n--------------------------------');
        console.log('spawn cap %s hit, bailing..', options.spawn);
        console.log('--------------------------------\n\n');
        process.exit(1);
    }
    process.env.PROC_SPAWN = proc;
    process.env.PARENT_PID = process.pid;
    child = exec(process.execPath, argv, {
        cwd: process.cwd(),
        env: process.env,
        stdio: 'inherit'
    });
    var a = [];
    var sinceAdded;
    argv.forEach(function(item) {
        switch (item) {
            case '--clean':
                break;
            case '--since':
                sinceAdded = true;
                break;
            default:
                if (sinceAdded) {
                    sinceAdded = null;
                    break;
                }
                a.push(item);
                break;
        }
    });
    argv = a;

    child.on('close', function(code) {
        if (code >= 250) {
            //Internal error..
            process.exit(1);
        }
        console.log('\n\n--------------------------------');
        console.log('subprocess exited with code', code, 'restarting process..');
        console.log('--------------------------------\n\n');
        run(code);
    });
};

//Start the script in a child process, restarting on error..
run();
